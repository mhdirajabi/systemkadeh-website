{% extends 'base.html' %}
{% load static %}

{% block title %}محصولات - {{ site_settings.site_name }}{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-lg-3">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">فیلتر محصولات</h5>
                </div>
                <div class="card-body">
                    <!-- Category Filter -->
                    <div class="mb-4">
                        <h6>دسته‌بندی</h6>
                        <div class="list-group list-group-flush">
                            <a href="{% url 'catalog:product_list' %}" 
                               class="list-group-item list-group-item-action {% if not request.GET.category %}active{% endif %}">
                                همه دسته‌ها
                            </a>
                            {% for category in categories %}
                                <a href="?category={{ category.slug }}" 
                                   class="list-group-item list-group-item-action {% if request.GET.category == category.slug %}active{% endif %}">
                                    {{ category.name }}
                                    <span class="badge bg-secondary float-start">{{ category.products.count }}</span>
                                </a>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Brand Filter -->
                    <div class="mb-4">
                        <h6>برند</h6>
                        <div class="list-group list-group-flush">
                            <a href="{% url 'catalog:product_list' %}" 
                               class="list-group-item list-group-item-action {% if not request.GET.brand %}active{% endif %}">
                                همه برندها
                            </a>
                            {% for brand in brands %}
                                <a href="?brand={{ brand.slug }}" 
                                   class="list-group-item list-group-item-action {% if request.GET.brand == brand.slug %}active{% endif %}">
                                    {{ brand.name }}
                                    <span class="badge bg-secondary float-start">{{ brand.products.count }}</span>
                                </a>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Price Filter -->
                    <div class="mb-4">
                        <h6>محدوده قیمت</h6>
                        <form hx-get="{% url 'catalog:product_list' %}" hx-target="#products-container" hx-indicator="#products-loading">
                            <div class="row">
                                <div class="col-6">
                                    <input type="number" class="form-control form-control-sm" name="min_price" 
                                           placeholder="حداقل" value="{{ request.GET.min_price }}">
                                </div>
                                <div class="col-6">
                                    <input type="number" class="form-control form-control-sm" name="max_price" 
                                           placeholder="حداکثر" value="{{ request.GET.max_price }}">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary btn-sm w-100 mt-2">اعمال فیلتر</button>
                        </form>
                    </div>
                    
                    <!-- Sort Options -->
                    <div class="mb-4">
                        <h6>مرتب‌سازی</h6>
                        <select class="form-select" hx-get="{% url 'catalog:product_list' %}" 
                                hx-target="#products-container" hx-indicator="#products-loading" name="sort">
                            <option value="">پیش‌فرض</option>
                            <option value="price_asc" {% if request.GET.sort == 'price_asc' %}selected{% endif %}>قیمت: کم به زیاد</option>
                            <option value="price_desc" {% if request.GET.sort == 'price_desc' %}selected{% endif %}>قیمت: زیاد به کم</option>
                            <option value="name_asc" {% if request.GET.sort == 'name_asc' %}selected{% endif %}>نام: الف تا ی</option>
                            <option value="name_desc" {% if request.GET.sort == 'name_desc' %}selected{% endif %}>نام: ی تا الف</option>
                            <option value="newest" {% if request.GET.sort == 'newest' %}selected{% endif %}>جدیدترین</option>
                            <option value="popular" {% if request.GET.sort == 'popular' %}selected{% endif %}>پرفروش‌ترین</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Products -->
        <div class="col-lg-9">
            <!-- Breadcrumb -->
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'core:home' %}">خانه</a></li>
                    <li class="breadcrumb-item active">محصولات</li>
                </ol>
            </nav>
            
            <!-- Page Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>محصولات</h2>
                <div class="d-flex align-items-center">
                    <span class="text-muted me-3">نمایش:</span>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary active" onclick="changeView('grid')">
                            <i class="bi bi-grid-3x3-gap"></i>
                        </button>
                        <button type="button" class="btn btn-outline-primary" onclick="changeView('list')">
                            <i class="bi bi-list"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Products Container -->
            <div id="products-container">
                <div class="row" id="products-grid">
                    {% for product in products %}
                        <div class="col-lg-4 col-md-6 mb-4">
                            <div class="card product-card h-100">
                                {% if product.images.first %}
                                    <img src="{{ product.images.first.image.url }}" class="card-img-top" alt="{{ product.name }}">
                                {% endif %}
                                
                                {% if product.discount_percentage > 0 %}
                                    <div class="discount-badge">{{ product.discount_percentage }}%</div>
                                {% endif %}
                                
                                <div class="card-body d-flex flex-column">
                                    <h6 class="card-title">{{ product.name }}</h6>
                                    <p class="card-text text-muted small">{{ product.short_description|truncatewords:15 }}</p>
                                    
                                    <div class="mt-auto">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <div>
                                                <span class="price">{{ product.price|floatformat:0 }} تومان</span>
                                                {% if product.compare_price %}
                                                    <small class="old-price d-block">{{ product.compare_price|floatformat:0 }} تومان</small>
                                                {% endif %}
                                            </div>
                                            <div class="text-end">
                                                <div class="rating">
                                                    {% for i in "12345" %}
                                                        {% if forloop.counter <= product.average_rating %}
                                                            <i class="bi bi-star-fill text-warning"></i>
                                                        {% else %}
                                                            <i class="bi bi-star text-muted"></i>
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                                <small class="text-muted">({{ product.review_count }})</small>
                                            </div>
                                        </div>
                                        
                                        <div class="d-flex gap-2">
                                            <a href="{{ product.get_absolute_url }}" class="btn btn-outline-primary btn-sm flex-fill">
                                                مشاهده
                                            </a>
                                            <button class="btn btn-primary btn-sm" 
                                                    hx-post="{% url 'cart:add_to_cart' %}" 
                                                    hx-vals='{"product_id": "{{ product.id }}", "quantity": "1"}'
                                                    hx-target="#cart-count"
                                                    hx-indicator="#add-to-cart-loading">
                                                <span id="add-to-cart-loading" class="htmx-indicator">
                                                    <span class="spinner-border spinner-border-sm" role="status"></span>
                                                </span>
                                                <i class="bi bi-cart-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% empty %}
                        <div class="col-12">
                            <div class="text-center py-5">
                                <i class="bi bi-search text-muted" style="font-size: 4rem;"></i>
                                <h4 class="text-muted mt-3">محصولی یافت نشد</h4>
                                <p class="text-muted">لطفاً فیلترهای جستجو را تغییر دهید</p>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                
                <!-- Pagination -->
                {% if products.has_other_pages %}
                    <nav aria-label="صفحه‌بندی محصولات">
                        <ul class="pagination justify-content-center">
                            {% if products.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ products.previous_page_number }}">قبلی</a>
                                </li>
                            {% endif %}
                            
                            {% for num in products.paginator.page_range %}
                                {% if products.number == num %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ num }}</span>
                                    </li>
                                {% elif num > products.number|add:'-3' and num < products.number|add:'3' %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                                    </li>
                                {% endif %}
                            {% endfor %}
                            
                            {% if products.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ products.next_page_number }}">بعدی</a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function changeView(view) {
        const grid = document.getElementById('products-grid');
        const buttons = document.querySelectorAll('.btn-group button');
        
        buttons.forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        if (view === 'list') {
            grid.className = 'row';
            grid.querySelectorAll('.col-lg-4').forEach(col => {
                col.className = 'col-12 mb-3';
            });
        } else {
            grid.className = 'row';
            grid.querySelectorAll('.col-12').forEach(col => {
                col.className = 'col-lg-4 col-md-6 mb-4';
            });
        }
    }
    
    // Handle add to cart success
    document.body.addEventListener('htmx:afterRequest', function(event) {
        if (event.detail.xhr.status === 200) {
            const response = JSON.parse(event.detail.xhr.responseText);
            if (response.success) {
                // Update cart count
                document.getElementById('cart-count').textContent = response.cart_total;
                
                // Show success message
                showToast('success', response.message);
            } else {
                showToast('danger', response.message);
            }
        }
    });
    
    function showToast(type, message) {
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${type} border-0`;
        toast.setAttribute('role', 'alert');
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
        
        document.body.appendChild(toast);
        
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
        
        toast.addEventListener('hidden.bs.toast', () => {
            toast.remove();
        });
    }
</script>
{% endblock %}